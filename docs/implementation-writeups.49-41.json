{
  "generated_at_utc": "2026-02-02T00:00:00Z",
  "source": {
    "work_packages": "docs/work-packages.json",
    "skills": [
      ".github/skills/timestamps-utc/SKILL.md",
      ".github/skills/offline-encrypted-queue/SKILL.md",
      ".github/skills/test-coverage-critical-workflows/SKILL.md",
      ".github/skills/compliance-guardrails/SKILL.md"
    ],
    "prompt": ".github/prompts/backend-log-submit-and-note.prompt.md"
  },
  "notes": [
    "This file is an implementation brief for the engineering team.",
    "Backend code does not currently appear in this repo; if the backend lives elsewhere, port these requirements to that service.",
    "All errors exposed to clients should be deterministic (static codes/strings), per compliance skills."
  ],
  "issues": {
    "49": {
      "number": 49,
      "title": "Task: Backend – Store submitted_at_utc",
      "lane": "backend",
      "skills_required": [
        "timestamps-utc",
        "compliance-guardrails",
        "test-coverage-critical-workflows"
      ],
      "goal": "Implement POST /api/logs so the backend stamps submitted_at_utc server-side in UTC, ignores any client-provided submitted_at_utc, and persists the value.",
      "api_contract": {
        "method": "POST",
        "path": "/api/logs",
        "request_fields": [
          "client_id",
          "log_type",
          "fields",
          "consent"
        ],
        "response_fields": [
          "id",
          "client_id",
          "log_type",
          "submitted_at_utc"
        ],
        "required_behavior": [
          "submitted_at_utc is generated on the server in UTC for every created log.",
          "If the client sends submitted_at_utc, it is ignored and never persisted.",
          "Response returns submitted_at_utc generated by server.",
          "Errors must be deterministic (static codes/strings)."
        ]
      },
      "acceptance_criteria": [
        "When a log is created via POST /api/logs, submitted_at_utc is set on the server, in UTC.",
        "The backend ignores any submitted_at_utc provided by the client.",
        "submitted_at_utc is persisted in the SQL schema for ClientLogEntry.",
        "Unit tests verify that submitted_at_utc is not null and is in UTC."
      ],
      "implementation_tasks": [
        {
          "id": "49.1",
          "title": "Add submitted_at_utc column",
          "details": [
            "Add submitted_at_utc to ClientLogEntry persistence model.",
            "Make it NOT NULL and store in a UTC-safe format (e.g., timestamptz / ISO8601 with Z).",
            "Ensure migrations are reversible and consistent across environments."
          ]
        },
        {
          "id": "49.2",
          "title": "Implement POST /api/logs",
          "details": [
            "Validate request: client_id, log_type, fields, consent.",
            "Reject or block if consent is not granted per compliance rules.",
            "Set submitted_at_utc = now() in UTC on the server at insert time.",
            "Explicitly ignore any submitted_at_utc in request body.",
            "Return created log with submitted_at_utc."
          ]
        },
        {
          "id": "49.3",
          "title": "Deterministic error model",
          "details": [
            "Define a small set of static error codes/strings (e.g., CONSENT_REQUIRED, VALIDATION_ERROR, INTERNAL_ERROR).",
            "Map all failures to deterministic responses; avoid dynamic messages, stack traces, or embedded timestamps in error text."
          ]
        }
      ],
      "tests": {
        "required": [
          {
            "id": "49.t1",
            "name": "server stamps submitted_at_utc",
            "assertions": [
              "Response includes submitted_at_utc.",
              "submitted_at_utc parses as a UTC timestamp (e.g., ends with 'Z' if using ISO string).",
              "Persisted row has non-null submitted_at_utc."
            ]
          },
          {
            "id": "49.t2",
            "name": "client timestamp is ignored",
            "assertions": [
              "If request includes submitted_at_utc = '2000-01-01T00:00:00Z', response submitted_at_utc is not that value.",
              "Persisted value matches the server-stamped timestamp (not the client value)."
            ]
          },
          {
            "id": "49.t3",
            "name": "deterministic validation errors",
            "assertions": [
              "Missing required fields yields a static error code/string.",
              "Error payload does not include dynamic content (timestamps, stack traces)."
            ]
          }
        ]
      },
      "definition_of_done": [
        "POST /api/logs stamps submitted_at_utc server-side in UTC.",
        "Client-provided submitted_at_utc is ignored.",
        "submitted_at_utc is persisted for ClientLogEntry.",
        "Tests cover stamping, ignore-client behavior, and deterministic errors."
      ],
      "open_questions": [
        "Which backend stack/service will host /api/logs? This repo currently looks client-only.",
        "What database is used (Postgres/SQLite/etc.) so timestamp type can be chosen appropriately?"
      ]
    },
    "41": {
      "number": 41,
      "title": "Task: Backend – Idempotent Submission Handling",
      "lane": "backend",
      "skills_required": [
        "offline-encrypted-queue",
        "test-coverage-critical-workflows",
        "compliance-guardrails"
      ],
      "goal": "Make retries safe by ensuring duplicate submissions of the same queued log do not create duplicate ClientLogEntry records (or downstream artifacts like DraftNotes).",
      "background": [
        "The client performs auto-sync and may retry submissions after timeouts, reconnects, or app restarts.",
        "Without idempotency, retries can create duplicate logs and later duplicate pending-review draft notes.",
        "Critical workflow tests require idempotent retries and deterministic behavior."
      ],
      "recommended_contract_change": {
        "preferred": {
          "type": "request_field",
          "name": "idempotency_key",
          "where": "POST /api/logs body",
          "rationale": "A stable client-generated UUID persisted with the queued item is the most reliable dedupe key across retries."
        },
        "alternative": {
          "type": "header",
          "name": "Idempotency-Key",
          "where": "HTTP header",
          "rationale": "Keeps request body simpler but requires consistent client header behavior."
        },
        "not_recommended": [
          "Hashing the payload for dedupe (fragile across serialization differences)."
        ]
      },
      "implementation_tasks": [
        {
          "id": "41.1",
          "title": "Add idempotency key to persistence",
          "details": [
            "Add idempotency_key column to ClientLogEntry.",
            "Add unique constraint (either UNIQUE(idempotency_key) or UNIQUE(client_id, idempotency_key)).",
            "Add index to support lookups."
          ]
        },
        {
          "id": "41.2",
          "title": "Implement insert-or-return-existing behavior",
          "details": [
            "On POST /api/logs, if idempotency_key already exists, return the existing log record.",
            "Do not create a new record, do not update submitted_at_utc on retries.",
            "Make race-safe by relying on the DB unique constraint and handling conflict deterministically."
          ]
        },
        {
          "id": "41.3",
          "title": "Deterministic error model",
          "details": [
            "Return deterministic responses for missing/invalid idempotency keys.",
            "Avoid exposing DB vendor-specific conflict errors."
          ]
        }
      ],
      "interaction_with_issue_49": [
        "The first accepted submission stamps submitted_at_utc.",
        "All retries return the same id and the original submitted_at_utc (no refresh on retry)."
      ],
      "draft_note_safety_for_future_issues": [
        "When DraftNotes are created on log creation, idempotent retries must not create duplicate DraftNotes.",
        "Common approach: DraftNote has unique source_log_entry_id; if log is reused, draft note is reused."
      ],
      "tests": {
        "required": [
          {
            "id": "41.t1",
            "name": "duplicate submissions do not duplicate logs",
            "assertions": [
              "Two POST /api/logs calls with same idempotency key return same log id.",
              "Database contains exactly one ClientLogEntry row for that key."
            ]
          },
          {
            "id": "41.t2",
            "name": "submitted_at_utc stable across retries",
            "assertions": [
              "First response submitted_at_utc equals second response submitted_at_utc.",
              "Persisted submitted_at_utc value is unchanged after retry."
            ]
          },
          {
            "id": "41.t3",
            "name": "deterministic conflict and validation handling",
            "assertions": [
              "Missing idempotency key yields static error code/string.",
              "If a DB conflict occurs, API returns a deterministic response (no raw DB error text)."
            ]
          }
        ],
        "high_value_optional": [
          {
            "id": "41.t4",
            "name": "concurrency safety",
            "assertions": [
              "Two concurrent requests with same key still produce one row.",
              "Both responses reference the same id."
            ]
          }
        ]
      },
      "definition_of_done": [
        "Retries of the same queued log do not create duplicate ClientLogEntry records.",
        "Idempotent retries return the same id and the same submitted_at_utc.",
        "Tests prove non-duplication and deterministic behavior.",
        "Design anticipates future DraftNote creation without duplicates."
      ],
      "open_questions": [
        "Will the client include idempotency_key in request body or as a header?",
        "What is the desired HTTP status for an idempotent replay (200 vs 201)? (Either is fine if consistent.)"
      ]
    }
  }
}
